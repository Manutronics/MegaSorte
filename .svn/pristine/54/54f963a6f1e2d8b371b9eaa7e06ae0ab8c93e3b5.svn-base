#include "pastraffle.h"
#include <QDebug>

PastRaffle::PastRaffle()
{
    QString name("../ColorSlider/dataBase.sqlite");
    db = QSqlDatabase::addDatabase("QSQLITE");
    db.setDatabaseName(name);
    if(db.open())
    {
        qDebug() << "Conectado a base de dados";
    }
    else
    {
        qDebug() << "Não conectado a base de dados";
    }
    tableCreate("pastraffle");
}

void PastRaffle::tableCreate(QString table)
{
    QString enquiry;
    enquiry.append(QString("CREATE TABLE IF NOT EXISTS %1("
                 "id INTEGER PRIMARY KEY AUTOINCREMENT,"
                 "firstColumn INTEGER NOT NULL,"
                 "secondColumn INTEGER NOT NULL,"
                 "thirdColumn INTEGER NOT NULL,"
                 "fourthColumn INTEGER NOT NULL,"
                 "fifthColumn INTEGER NOT NULL,"
                 "sixthColumn INTEGER NOT NULL,"
                 "date DATETIME NOT NULL"
                 ");").arg(table));
    QSqlQuery query;
    query.prepare(enquiry);

    if(query.exec())
    {
        qDebug() << "Tabela criada com sucesso!";
    }
    else
    {
        qDebug() << "A tabela rafflenumbs não existe e/ou não foi criada corretamente";
        qDebug() << "ERROR ->" << query.lastError();
    }
}

void PastRaffle::insertNumbers(QString table, QVector<int> &nums)
{
    QDateTime time = QDateTime::currentDateTime();
    QString enquiry;
    enquiry.append(QString("INSERT INTO %1("
                 "firstColumn,"
                 "secondColumn,"
                 "thirdColumn,"
                 "fourthColumn,"
                 "fifthColumn,"
                 "sixthColumn,"
                 "date)").arg(table));
    enquiry.append(QString("VALUES(%1, %2, %3, %4, %5, %6, '%7');").arg(nums[0])
            .arg(nums[1]).arg(nums[2]).arg(nums[3]).arg(nums[4]).arg(nums[5]).arg(time.toString("yyyy-MM-dd hh:mm:ss")));
    QSqlQuery insertQuery;
    insertQuery.prepare(enquiry);

    if(insertQuery.exec())
    {
        qDebug() << "Linha inserida com sucesso!";
    }
    else
    {
        qDebug() << "Não foi possivel inserir linha corretamente";
        qDebug() << "ERROR ->" << insertQuery.lastError();
    }
}

int PastRaffle::pickAllNumbers(QString table, QVector<QVector<int>> &vec)
{
    QString enquiry;
    enquiry.append(QString("SELECT * FROM %1").arg(table));

    QSqlQuery retrieveQuery;
    retrieveQuery.prepare(enquiry);

    if(retrieveQuery.exec())
    {
        qDebug() << "Consulta realizada com sucesso!";
    }
    else
    {
        qDebug() << "Não foi possivel consultar linha corretamente";
        qDebug() << "ERROR ->" << retrieveQuery.lastError();
    }

    QVector<int> temp;
    int rows = retrieveQuery.size();

    while(retrieveQuery.next())
    {
        temp.append(retrieveQuery.value(1).toInt());
        temp.append(retrieveQuery.value(2).toInt());
        temp.append(retrieveQuery.value(3).toInt());
        temp.append(retrieveQuery.value(4).toInt());
        temp.append(retrieveQuery.value(5).toInt());
        temp.append(retrieveQuery.value(6).toInt());
        vec.append(temp);
        temp.clear();
    }
    return rows;
}

QVector<int> PastRaffle::pickNumbers(QString table, int line)
{
    QString enquiry;
    enquiry.append(QString("SELECT * FROM %1 WHERE id=%2").arg(table).arg(line));

    QSqlQuery retrieveQuery;
    retrieveQuery.prepare(enquiry);

    if(retrieveQuery.exec())
    {
        qDebug() << "Consulta unica realizada com sucesso!";
    }
    else
    {
        qDebug() << "Não foi possivel consultar linha corretamente";
        qDebug() << "ERROR ->" << retrieveQuery.lastError();
    }

    QVector<int> temp;
    if(retrieveQuery.first())
    {
        temp.append(retrieveQuery.value(1).toInt());
        temp.append(retrieveQuery.value(2).toInt());
        temp.append(retrieveQuery.value(3).toInt());
        temp.append(retrieveQuery.value(4).toInt());
        temp.append(retrieveQuery.value(5).toInt());
        temp.append(retrieveQuery.value(6).toInt());
    }

    return temp;
}

int PastRaffle::linesCount(QString table)
{
    QString enquiry;
    enquiry.append(QString("SELECT COUNT(*) FROM %1").arg(table));

    QSqlQuery retrieveQuery;
    retrieveQuery.prepare(enquiry);

    if(retrieveQuery.exec())
    {
        qDebug() << "Consulta unica realizada com sucesso!";
    }
    else
    {
        qDebug() << "Não foi possivel consultar linha corretamente";
        qDebug() << "ERROR ->" << retrieveQuery.lastError();
    }
}
